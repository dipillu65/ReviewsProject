<html>
    <head>
        <!--ACCESS GOOGLE CHARTS AND OTHER DEPENDENTS-->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript" src="./db.js"></script>
    </head>

    <body>
        <!--UNIQUE BOOK GRAPHICS-->
        <h1>Review Analyzer</h1>
        <h2>Find a book</h2>
        <select id="selectBook" onchange="displayData()">
            <option>--choose a book--</option>
        </select>
        <table class="columns">
            <tr>
                <td><div id="chart_div" style="border: 1px solid #ccc"></div></td>
                <td><div id="table_div" style="border: 1px solid #ccc"></div></td>
            </tr>
        </table>

        <!--UNIQUE USER GRAPHICS-->
        <h2>Find a Reviewer</h2>
        <select id="selectReviewer" onchange="displayRevData()">
            <option>--choose a user--</option>
        </select>
        <table class="columns">
            <tr>
                <td><div id="reviewer_chart_div" style="border: 1px solid #ccc"></div></td>
                <td><div id="reviewer_table_div" style="border: 1px solid #ccc"></div></td>
            </tr>
        </table>
    </body>

<script>

// DISPLAY CHARTS **need to edit this; may not need
google.charts.load('current', {packages: ['corechart']});
google.charts.load('current', {packages:['table']});

//OBTAIN SENTIMENT SCORE AND ASIN FOR CHART **Not needed
var sentiments = reviews.map((element)=>{
    date = new Date (element.date);
    return [date, element.sentimentScore];
})
sentiments = sentiments.sort((a,b) => {return a[0]-b[0]});

//POPULATE BOOK DROPDOWN
var select = document.getElementById("selectBook");
var Ids = reviews.map((review) => {
    return review.asin;
})  
uniqueIds = [...new Set(Ids)]

//LOOP THORUGH uniqueIds TO POPULATE DROPDOWN
for(var i = 0; i < uniqueIds.length; i++){
    var opt = uniqueIds[i];
    var el = document.createElement("option");
    el.textContent = opt; //define text content of element to be uniqueIds elements
    el.value = opt;
    select.appendChild(el)
}

// POPULATE REVIEWER DROPDOWN
var userSelect = document.getElementById("selectReviewer");
var Ids = reviews.map((review) => {
    return review.reviewerID;
});
reviewerIds = [...new Set(Ids)]

//Loop through reviewerIds array and populate reviewer dropdown
for(var i = 0; i < reviewerIds.length; i++){
    var opt = reviewerIds[i];
    var el = document.createElement("option");
    el.textContent = opt; //define text content of element to be reviewerIds elements
    el.value = opt;
    userSelect.appendChild(el)
}

var bookChart;
var reviewerChart;
var options = {

    chart: {
    title: 'Sentiment',
    subtitle: 'in millions of dollars (USD)'
    },
    width: 1000,
    height: 500,
    hAxis: {
    title: 'Date'
    },
    vAxis: {
    title: 'Sentiment'
    },
    colors: ['#AB0D06', '#007329'],
    trendlines: {
    0: {type: 'linear', color: '#111', opacity: .3}
    },

};

// BOOK ENTITY COMPLIATION
var allBookEntities = uniqueIds.map((book) => {
    var bookReviews = reviews.filter((rev) => {return rev.asin === book});
    var entityData = {};
    entityData.asin = book;
    var bookEntities = [];
    bookReviews.forEach((book) => {
        book.entities.forEach((entity) => {
            var found = false;
            for(var i = 0; i < bookEntities.length; i++) {
                if (bookEntities[i].name === entity.name) {
                    found = true;
                    var sali = entity.salience;
                    bookEntities[i].count += 1;
                    bookEntities[i].weight += entity.score * sali;
                    bookEntities[i].saliSum += sali;
                    bookEntities[i].salience = bookEntities[i].saliSum/(bookEntities[i].count);
                    bookEntities[i].score = bookEntities[i].weight/bookEntities[i].saliSum;
                    break;
                }
            }
            if(!found){
                entity.count = 1;
                entity.weight = entity.salience * entity.score;
                entity.saliSum = entity.salience;
                bookEntities.push(entity);
            }
        });
    });
    bookEntities = bookEntities.map((book) => {
        return [book.name, book.score, {v:book.salience,f: Math.round(book.salience*10000)/100 + '%'}]
    });
    entityData.entities = bookEntities;
    return entityData
});

// USER ENTITY COMPILATION *** Sort based on number of reviews
var allReviewerEntities = reviewerIds.map((user) => {
    var userReviews = reviews.filter((rev) => {return rev.reviewerID === user});
    var userData = {};
    userData.reviewerID = user;
    var userEntities = [];
    userReviews.forEach((user) => {
        user.entities.forEach((entity) => {
            var found = false;
            for(var i = 0; i < userEntities.length; i++) {
                if (userEntities[i].name === entity.name) {
                    found = true;
                    var sali = entity.salience;
                    userEntities[i].count += 1;
                    userEntities[i].weight += entity.score * sali;
                    userEntities[i].saliSum += sali;
                    userEntities[i].salience = userEntities[i].saliSum/(userEntities[i].count);
                    userEntities[i].score = userEntities[i].weight/userEntities[i].saliSum;
                    console.log(userEntities[i].salience)
                    break;
                }
            }
            if(!found){
                entity.count = 1;
                entity.weight = entity.salience * entity.score;
                entity.saliSum = entity.salience;
                userEntities.push(entity);
            }
        });
    }); 
    userEntities = userEntities.map((user) => {
        return [user.name, user.score, {v:user.salience,f: Math.round(user.salience*10000)/100 + '%'}]
    });
    userData.entities = userEntities;
    return userData
});


//UPDATE GRAPH
function displayData(){

    var results = [];
    //Get selected option from dropdown
    var selectedID = document.getElementById('selectBook').options[document.getElementById('selectBook').selectedIndex].value;
    //Function to filter out revelant data from json file
    console.log(selectedID);
    reviews.forEach(item => {
        if (item.asin == selectedID){
            var element = [new Date (item.date),item.sentimentScore]
            results.push(element)
        }
    });
    results = results.sort((a,b) => {return a[0]-b[0]});
    console.log(results)
    var data = new google.visualization.DataTable();
    data.addColumn('date', 'X');
    data.addColumn('number', 'Product');
    data.addRows(results);

    bookChart = new google.visualization.LineChart(document.getElementById('chart_div'));
    bookChart.draw( data, options);
    
    var data = new google.visualization.DataTable();

    data.addColumn('string', 'Entity');
    data.addColumn('number', 'Score');
    data.addColumn('number', 'Salience');
    data.addRows(allBookEntities[allBookEntities.findIndex((item)=>{return item.asin == selectedID})].entities);

    var option = {
        title: 'Entities',
        width: 300,
        height: 500
    };
    var table = new google.visualization.Table(document.getElementById('table_div'));

    table.draw(data, option);
}

//DRAW REVIEWER GRAPH
function displayRevData(){

    var results = [];
    //Get selected option from dropdown
    var selectedID = document.getElementById('selectReviewer').options[document.getElementById('selectReviewer').selectedIndex].value;
    //Function to filter out revelant data from json file
    console.log(selectedID);
    reviews.forEach((item) => {
        if (item.reviewerID == selectedID){
            var element = [new Date (item.date),item.sentimentScore]
            results.push(element)
        }
    })
    results = results.sort((a,b) => {return a[0]-b[0]});
    console.log(results)
    var data = new google.visualization.DataTable();
    data.addColumn('date', 'X');
    data.addColumn('number', 'Product');
    data.addRows(results);

    reviewerChart = new google.visualization.LineChart(document.getElementById('reviewer_chart_div'));
    reviewerChart.draw(data, options);

    var data = new google.visualization.DataTable();

    data.addColumn('string', 'Entity');
    data.addColumn('number', 'Score');
    data.addColumn('number', 'Salience');
    data.addRows(allReviewerEntities[allReviewerEntities.findIndex((item)=>{return item.reviewerID == selectedID})].entities);

    var option = {
    title: 'Entities',
    width: 300,
    height: 500
    };
    var table = new google.visualization.Table(document.getElementById('reviewer_table_div'));

    table.draw(data, option);

}

</script>
</html>
  