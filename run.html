<html>
    <head>
      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
      <script type="text/javascript" src="./db.js"></script>
    </head>

    <body>
        <h1>Review Analyzer</h1>
        <h2>Find a book</h2>
        <select id="selectBook" onchange="displayData()">
                <option>Choose a book</option>
        </select>

      <!--Chart div for book-->
      <table class="columns">
        <tr>
          <td><div id="chart_div" style="border: 1px solid #ccc"></div></td>
          <td><div id="table_div" style="border: 1px solid #ccc"></div></td>
        </tr>
      </table>
      <h2>Find a Reviewer</h2>
      <select id="selectReviewer" onchange="displayRevData()">
        <option>Choose a Reviewer </option>
        <table class="columns">
          <tr>
        <!--Chart div for reviewer-->
        <td><div id="reviewer_chart_div" style="border: 1px solid #ccc"></div></td>
          <td><div id="reviewer_table_div" style="border: 1px solid #ccc"></div></td>
          </tr>
          </table>
</select>
    </body>

<script>  
google.charts.load('current', {packages: ['corechart']});
google.charts.load('current', {packages:['table']});
google.charts.setOnLoadCallback(drawBasic);
google.charts.setOnLoadCallback(drawTable);
google.charts.setOnLoadCallback(displayRevData);


//OBTAIN SENTIMENT SCORE AND ASIN FOR CHART **Not needed
var sentiments = reviews.map((element)=>{
  date = new Date (element.date);
  return [date, element.sentimentScore];
})
sentiments = sentiments.sort((a,b) => {return a[0]-b[0]});

//POPULATE DROPDOWN FOR BOOK 
var select = document.getElementById("selectBook");
var Ids = [];   
reviews.forEach( reviews => {
  Ids.push(reviews.asin);
})  
UniqueIds = [...new Set(Ids)]

//Loop through UniqueIds array and populate dropdown
for(var i = 0; i < UniqueIds.length; i++){
  var opt = UniqueIds[i];
  var el = document.createElement("option");
  el.textContent = opt; //define text content of element to be UniqueIds elements
  el.value = opt;
  select.appendChild(el)
}

// POPULATE REVIEWER DROPDOWN
var reviewerSelect = document.getElementById("selectReviewer");  // Add a new element for reviewer selection
var Ids = reviews.map((review) => {
  return review.reviewerID;
});
reviewerIds = [...new Set(Ids)]

//Loop through reviewerIds array and populate reviewer dropdown
for(var i = 0; i < reviewerIds.length; i++){
  var opt = reviewerIds[i];
  var el = document.createElement("option");
  el.textContent = opt; //define text content of element to be reviewerIds elements
  el.value = opt;
  reviewerSelect.appendChild(el)
}

var chart;
var options;

//ENTITY ANALYSIS CALCULATIONS
var allBookEntities = UniqueIds.map((book) => {
    var bookReviews = reviews.filter((rev) => {return rev.asin === book});
    var entityData = {};
    entityData.asin = book;
    var bookEntities = [];
    bookReviews.forEach((book) => {
        book.entities.forEach((entity) => {
            var found = false;
            for(var i = 0; i < bookEntities.length; i++) {
                if (bookEntities[i].name === entity.name) {
                    found = true;
                    var sali = entity.salience;
                    bookEntities[i].count += 1;
                    bookEntities[i].weight += entity.score * sali;
                    bookEntities[i].saliSum += sali;
                    bookEntities[i].salience = bookEntities[i].saliSum/(bookEntities[i].count);
                    bookEntities[i].score = bookEntities[i].weight/bookEntities[i].saliSum;
                    console.log(bookEntities[i].salience)
                    break;
                }
            }
            if(!found){
                entity.count = 1;
                entity.weight = entity.salience * entity.score;
                entity.saliSum = entity.salience;
                bookEntities.push(entity);
            }
        });
    });
    bookEntities = bookEntities.map((book) => {
        return [book.name, book.score, {v:book.salience,f: Math.round(book.salience*10000)/100 + '%'}]
    });
    entityData.entities = bookEntities;
    return entityData
});


//DRAW INITIAL GRAPH
function drawBasic() {
  var data = new google.visualization.DataTable();
  data.addColumn('date', 'X');
  data.addColumn('number', 'Product');
  data.addRows(sentiments);
  console.log(sentiments)

  options = {
    chart: {
      title: 'Sentiment',
      subtitle: 'in millions of dollars (USD)'
    },
    width: 1000,
    height: 500,
    hAxis: {
      title: 'Date'
    },
    vAxis: {
      title: 'Sentiment'
    },
    colors: ['#AB0D06', '#007329'],
    trendlines: {
      0: {type: 'linear', color: '#111', opacity: .3}
    },
  
  };

  chart = new google.visualization.LineChart(document.getElementById('chart_div'));

  chart.draw(data, options);
}


//UPDATE GRAPH
function displayData(){
var results = [];
  //Get selected option from dropdown
  var selectedID = document.getElementById('selectBook').options[document.getElementById('selectBook').selectedIndex].value;
  //Function to filter out revelant data from json file
 console.log(selectedID);
 reviews.forEach(item => {
   if (item.asin == selectedID){
     var element = [new Date (item.date),item.sentimentScore]
     results.push(element)
   }
 })
 results = results.sort((a,b) => {return a[0]-b[0]});
 console.log(results)
 var data = new google.visualization.DataTable();
  data.addColumn('date', 'X');
  data.addColumn('number', 'Product');
  data.addRows(results);

  chart.draw( data, options);

  var data = new google.visualization.DataTable();

  data.addColumn('string', 'Entity');
  data.addColumn('number', 'Score');
  data.addColumn('number', 'Salience');
  var ind = allBookEntities.findIndex((item)=>{return item.asin == selectedID});
  console.log(ind);
  data.addRows(allBookEntities[ind].entities);

  var option = {
title: 'Entities',
  width: 300,
  height: 500
};
  var table = new google.visualization.Table(document.getElementById('table_div'));

  table.draw(data, option);
}

//DRAW SENTIMENT TABLE
function drawTable() {
        
}


//DRAW REVIEWER GRAPH
function displayRevData(){
  var results = [];
  var selectedID = document.getElementById('selectBook').options[document.getElementById('selectBook').selectedIndex].value;



}

</script>
</html>
  